# 5장: 데이터 처리 및 변환

> 데이터를 효과적으로 처리, 변환, 필터링하는 방법을 배웁니다.
> 예상 학습 시간: 1.5시간

## 기본 데이터 구조 이해

### JSON 구조

```json
{
  "user": {
    "id": 123,
    "name": "John",
    "email": "john@example.com",
    "active": true,
    "tags": ["vip", "early-adopter"],
    "profile": {
      "avatar": "https://...",
      "bio": "Developer"
    }
  },
  "items": [
    {"id": 1, "price": 100},
    {"id": 2, "price": 200}
  ]
}
```

### 데이터 접근 방법

```javascript
// 최상위 필드
{{ $json.user.name }}           // "John"
{{ $json.user.id }}             // 123

// 배열 요소
{{ $json.items[0].price }}      // 100
{{ $json.items.length }}        // 2

// 배열 반복
{{ $json.items.map(x => x.price) }}  // [100, 200]

// 배열 필터링
{{ $json.items.filter(x => x.price > 150) }}  // [{id:2, price:200}]
```

## 데이터 변환 패턴

### 패턴 1: 필드명 변경

```javascript
// 입력:
{
  "firstName": "John",
  "lastName": "Doe"
}

// 변환 (Set 노드):
{
  "first_name": "{{ $json.firstName }}",
  "last_name": "{{ $json.lastName }}"
}

// 출력:
{
  "first_name": "John",
  "last_name": "Doe"
}
```

### 패턴 2: 배열 변환

```javascript
// 입력:
{
  "users": [
    {"id": 1, "name": "Alice"},
    {"id": 2, "name": "Bob"}
  ]
}

// 변환:
{
  "names": "{{ $json.users.map(u => u.name) }}"
}

// 출력:
{
  "names": ["Alice", "Bob"]
}
```

### 패턴 3: 조건부 변환

```javascript
// 입력:
{
  "age": 25,
  "score": 85
}

// 변환:
{
  "category": "{{ $json.age > 18 ? 'Adult' : 'Minor' }}",
  "grade": "{{ $json.score >= 80 ? 'A' : 'B' }}"
}

// 출력:
{
  "category": "Adult",
  "grade": "A"
}
```

### 패턴 4: 데이터 집계

```javascript
// 입력:
{
  "sales": [100, 200, 150, 300, 250]
}

// 변환:
{
  "total": "{{ $json.sales.reduce((a,b) => a+b, 0) }}",
  "average": "{{ $json.sales.reduce((a,b) => a+b, 0) / $json.sales.length }}",
  "max": "{{ Math.max(...$json.sales) }}"
}

// 출력:
{
  "total": 1000,
  "average": 200,
  "max": 300
}
```

## 주요 데이터 처리 노드

### 1. Set 노드 (기본 변환)

```
용도: 값 설정 및 간단한 변환
예시:
- 필드명 변경
- 새 필드 추가
- 값 계산
```

### 2. Merge 노드 (데이터 병합)

```
Mode: Different ways to merge
- Combine: 모든 데이터 병합
- Merge By Key: 특정 키로 병합
- Concatenate: 배열 이어붙이기

예시:
[데이터1] → [Merge] ← [데이터2]
           ↓
        [병합된 데이터]
```

### 3. Item Lists 노드 (배열 처리)

```
동작:
- Remove Duplicates: 중복 제거
- Sort: 정렬
- Combine arrays: 배열 합치기
- Remove by key: 특정 키 제거
```

### 4. Split In Batches (배치 처리)

```
용도: 큰 배열을 작은 묶음으로 나누기

설정:
Batch Size: 50

효과:
1000개 → 50개씩 20번 처리
```

### 5. Code 노드 (고급 처리)

```
Node.js 코드로 복잡한 처리 수행

예시:
return $json.items.map(item => ({
  id: item.id,
  price: item.price * 1.1,
  tax: item.price * 0.1
}));
```

## 실전 예시

### 예시 1: 고객 데이터 정리

```
입력:
{
  "firstName": "John",
  "lastName": "Doe",
  "emailAddress": "john@example.com",
  "phoneNo": "010-1234-5678"
}

프로세스:
1. Set 노드: 필드명 표준화
2. Set 노드: 데이터 검증 및 포맷팅
3. 출력

출력:
{
  "first_name": "John",
  "last_name": "Doe",
  "email": "john@example.com",
  "phone": "+82-10-1234-5678",
  "full_name": "John Doe"
}
```

### 예시 2: 판매 데이터 분석

```
입력:
{
  "sales": [
    {"product": "A", "price": 100, "quantity": 5},
    {"product": "B", "price": 200, "quantity": 3},
    {"product": "C", "price": 150, "quantity": 2}
  ]
}

프로세스:
1. Set: 각 항목의 총액 계산
2. Merge: 통계 추가
3. 출력

출력:
{
  "items": [
    {"product": "A", "total": 500},
    {"product": "B", "total": 600},
    {"product": "C", "total": 300}
  ],
  "summary": {
    "total_revenue": 1400,
    "average_order": 467,
    "item_count": 10
  }
}
```

## 성능 최적화

### Tip 1: 불필요한 데이터 제거

```javascript
// 낮음: 모든 필드 포함
{{ $json }}

// 좋음: 필요한 필드만
{{
  {
    id: $json.id,
    name: $json.name,
    email: $json.email
  }
}}
```

### Tip 2: 조기 필터링

```javascript
// 낮음: 모든 데이터 처리 후 필터링
{{ $json.items.filter(...) }}

// 좋음: API에서 미리 필터링
API 호출 시 쿼리 파라미터로 필터링
```

### Tip 3: 배치 처리

```javascript
// 낮음: 1000개씩 1번 처리
Loop with 1000 items

// 좋음: 100개씩 10번 처리
Split In Batches (100) → Loop
```

## 체크리스트

- [ ] JSON 구조 이해
- [ ] 데이터 접근 가능
- [ ] Set 노드로 변환 가능
- [ ] 배열 메서드 사용 가능
- [ ] 조건부 변환 가능
- [ ] 여러 노드 조합 가능

---

다음: [06_조건부실행.md](06_조건부실행.md)
