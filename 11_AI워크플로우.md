# 11장: 고급 AI 워크플로우

> Claude API를 활용한 고급 자동화 패턴을 배웁니다.
> 예상 학습 시간: 1.5시간

## 다단계 AI 처리

### 패턴: 단계별 분석

```
원본 텍스트
  ↓
[Claude] 감정 분석
  ↓
[Claude] 주요 내용 추출
  ↓
[Claude] 행동 제안
  ↓
[최종 결과]
```

### 구현

```
1단계: 데이터 받기
  Body: {{ $json.text }}

2단계: Claude 감정 분석
  Prompt: "다음 텍스트의 감정을 분석해줘: {{ $json.text }}"

3단계: Claude 주요 내용 추출
  Prompt: "다음 텍스트의 주요 내용을 3줄로 요약해줘: {{ $json.text }}"

4단계: 결과 통합
  {
    "original": "{{ $json.text }}",
    "sentiment": "{{ $node['감정분석'].json.content[0].text }}",
    "summary": "{{ $node['내용추출'].json.content[0].text }}"
  }
```

## 동적 프롬프트 생성

### 사용자 입력에 따른 다른 프롬프트

```javascript
// 입력에 따라 다른 프롬프트 생성

{{ 
  $json.task === 'summarize' 
    ? '다음 텍스트를 요약해줘: ' + $json.text
    : $json.task === 'translate'
    ? '다음 텍스트를 영어로 번역해줘: ' + $json.text
    : '다음 텍스트에 대해 조언해줘: ' + $json.text
}}
```

## 메모리를 활용한 대화

### 대화 히스토리 저장

```
1단계: 초기 메시지
  messages: [
    { "role": "user", "content": "안녕" }
  ]

2단계: 응답 받기
  Response: "안녕하세요!"

3단계: 메모리에 저장
  Database: 
  {
    "conversation_id": "abc123",
    "messages": [
      { "role": "user", "content": "안녕" },
      { "role": "assistant", "content": "안녕하세요!" }
    ]
  }

4단계: 다음 메시지 처리 시 히스토리 로드
  GET Database
  메시지 추가
  Claude 호출
```

## 조건부 AI 처리

### 신뢰도에 따른 처리

```
[Claude 호출]
  ↓
[신뢰도 확인]
  - 높음(>0.9): 결과 사용
  - 중간(0.5-0.9): 재검토 플래그
  - 낮음(<0.5): 재시도 또는 수동 검토
```

### 구현

```json
프롬프트:
"다음을 분석하고 신뢰도(0-1)를 JSON으로 반환해줘:
{
  \"result\": \"...\",
  \"confidence\": 0.85
}"

처리:
IF confidence > 0.9
  → 결과 사용
ELSE
  → 재처리 또는 알림
```

## RAG (Retrieval-Augmented Generation)

### 기본 개념

```
질문
  ↓
[데이터베이스에서 관련 문서 검색]
  ↓
[관련 문서 + 질문을 Claude로 전송]
  ↓
[답변 생성]
```

### 간단한 구현

```
1. 사용자 질문 받기
2. 데이터베이스에서 관련 정보 검색
3. Claude 호출:
   System: "다음 정보를 바탕으로 답변해줘"
   Context: [검색된 정보]
   User: [사용자 질문]
4. 답변 반환
```

## 에러 처리 및 재시도

### 기본 패턴

```
[Claude 호출]
  ↓
[에러 확인]
  - 성공: 계속
  - 429 (Rate Limit): 대기 후 재시도
  - 500 (Server Error): 재시도
  - 400 (Bad Request): 프롬프트 수정 후 재시도
```

### 구현 예

```
SET: 재시도 횟수 = 0

LOOP (최대 3번):
  Try:
    Claude 호출
    성공 → 종료
  Catch:
    Error code 확인
    IF 429 → WAIT 10초 → 재시도
    ELSE IF 500 → 재시도
    ELSE → 에러 로그 및 종료
```

## 비용 최적화

### 모델 선택

```
claude-3-5-haiku:
- 빠르고 저렴
- 간단한 작업에 적합
- 토큰 사용: 50% 이하

claude-3-5-sonnet:
- 균형 잡힘
- 대부분의 작업에 적합
- 권장

claude-3-opus:
- 강력함
- 복잡한 분석만 사용
```

### 구현

```
Switch on task type:
  - simple: haiku 사용
  - complex: sonnet 사용
  - very_complex: opus 사용
```

## 실전 예시

### 예시 1: 고객 지원 자동화

```
[Webhook: 고객 질문 수신]
  ↓
[Claude: 의도 파악]
  (구매, 배송, 반품 등)
  ↓
[Switch: 의도별 처리]
  - 구매 → 상품 추천
  - 배송 → 배송 상태 확인
  - 반품 → 반품 절차 안내
  ↓
[Claude: 맞춤 응답 생성]
  ↓
[Email/Chat 발송]
```

### 예시 2: 자동 보고서 생성

```
[스케줄: 매주 월요일 9시]
  ↓
[데이터 수집]
  - 판매 데이터
  - 고객 반응
  - 트렌드
  ↓
[Claude: 보고서 작성]
  ↓
[포맷팅]
  - 제목
  - 요약
  - 상세 분석
  - 추천사항
  ↓
[이메일 발송]
```

## 체크리스트

- [ ] 다단계 AI 처리 이해
- [ ] 동적 프롬프트 생성 가능
- [ ] 대화 히스토리 관리 가능
- [ ] 조건부 처리 가능
- [ ] 에러 처리 구현
- [ ] 비용 최적화 고려

---

다음: [12_프로젝트1_뉴스요약.md](12_프로젝트1_뉴스요약.md)
